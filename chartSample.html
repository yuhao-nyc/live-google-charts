<html>
<head>
<title>Uber Simple Websockets</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- Google Chart -->
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<!-- Websocket -->
<script type="text/javascript">

// Config
var port = 9000;
var host = "wss://streamssi.fxcorporate.com/streamssi/endpoint/EURUSD"; // No need to change this if using localhost


//Declare Variables
var socket;
var explodedValues = [0,0,0,0]; //initial value for the plot = 0

function init() {
	try {
		socket = new WebSocket(host);
		console.log('WebSocket status '+socket.readyState);
		socket.onopen = function(msg) {
							   console.log("Welcome - status "+this.readyState);
						   };
		socket.onmessage = function(msg) {

							   //console.log("Message Received: "+msg.data);
                               var json = '' + msg.data;
                                //console.log(evt.data);
                                json = json.replace('ssi', '');
                                //console.log(json);
                                var objJSON = eval(json);

                    $.each(objJSON.SSI, function (index, event) {

                            var noSlashSymb = event.Symbol.replace('/', '').toUpperCase();
                            var pres = 10000;
                            var totalOrders = parseInt(event.LongAmountKOrders, 10) + parseInt(event.ShortAmountKOrders, 10);
                            var longPercent = parseInt(event.LongAmountKOrders) * 100 / totalOrders;
                            var longPercent = parseInt(longPercent.toFixed(0));

                            var longSSI = parseInt(event.LongAmountKOrders);
                            var shortSSI = parseInt(event.ShortAmountKOrders);

                            var shortPercent = 100.00 - longPercent;
                            var histOrders = Math.round(event.SSIHistOrders * pres) / pres;
                            var s = padZeroWS(histOrders);
                            $("#ssi-present-" + noSlashSymb).html(s);
                            $("#ssi-present-" + noSlashSymb + 0).html(s);
                            $("#ssi-present-" + noSlashSymb + 1).html(s);
                            $("#ssi-long-prc-" + noSlashSymb).html(longPercent + "%");
                            $("#ssi-long-prc-" + noSlashSymb + 0).html(longPercent + "%").css("width", longPercent + "%");
                            $("#ssi-long-prc-" + noSlashSymb + 1).html(longPercent + "%");
                            $("#ssi-short-prc-" + noSlashSymb).html(shortPercent + "%");
                            $("#ssi-short-prc-" + noSlashSymb + 0).html(shortPercent + "%").css("width", shortPercent + "%");
                            $("#ssi-short-prc-" + noSlashSymb + 1).html(shortPercent + "%");
                            $(".long-knob-" + noSlashSymb).val(longPercent).trigger('change');
                            $(".short-knob-" + noSlashSymb).val(shortPercent).trigger('change');
                            //console.log(noSlashSymb);

                            explodedValues = [histOrders, longPercent, shortPercent];  //can be access for outter function
                            console.log(explodedValues);

                            for(var i=0; i<explodedValues.length; i++) { explodedValues[i] = +explodedValues[i]; }
                            drawVisualization();
                            //console.log(explodedValues);

                    });


							//console.log("Separate Values: "+explodedValues);

							//convert strings to numbers




                                    function padZeroWS(histOrders) {
            var s = Math.abs(histOrders) + "0000";
            var i = s.indexOf('.');
            var m = histOrders < 0 ? '-' : '';
            return m + s.substr(0, i) + s.substr(i, i + 4);
        }

						   };
		socket.onclose   = function(msg) {
							   console.log("Disconnected - status "+this.readyState);
						   };
	}
	catch(ex){
		console.log(ex);
	}

}

function quit(){
	if (socket != null) {
		console.log("Close Socket");
		socket.close();
		socket=null;
	}
}

function reconnect() {
	quit();
	init();
}


  function drawVisualization() {
    // Create and populate the data table from the values received via websocket
    var data = google.visualization.arrayToDataTable([
        ['Tracker', '1'],
        ['Historical', explodedValues[0]],
        ['Long', explodedValues[1]],
        ['Short', explodedValues[2]]
    ]);

    // use a DataView to 0-out all the values in the data set for the initial draw
    var view = new google.visualization.DataView(data);
    view.setColumns([0, {
        type: 'number',
        label: data.getColumnLabel(1),
        calc: function () {return 0;}
    }]);

    // Create and draw the plot
    var chart = new google.visualization.BarChart(document.getElementById('visualization'));

    var options = {
        title:"SSI",
        width: 300,
        height: 500,
        bar: { groupWidth: "40%" },
        legend: { position: "none" },
        hAxis: {
            // set these values to make the initial animation smoother
            minValue: 0,
            maxValue: 100
        }
    };

    var runOnce = google.visualization.events.addListener(chart, 'ready', function () {
        google.visualization.events.removeListener(runOnce);
        chart.draw(data, options);
    });

    chart.draw(view, options);

    // you can handle the resizing here - no need to recreate your data and charts from scratch
    $(window).resize(function() {
        chart.draw(data, options);
    });
}
google.load('visualization', '1', {packages: ['corechart'], callback: drawVisualization});


</script>




<script type="text/javascript">

</script>

</head>
<body onload="init()">
<h3>Uber Simple Websockets - Real Time Chart</h3>

<div id="visualization"></div>

<button onclick="reconnect()">Reconnect</button>

</body>
</html>