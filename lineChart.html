<html>
<head>
<title>Uber Simple Websockets</title>

<!-- might get rid of JQuery -->
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- Google Chart -->
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<!-- Websocket -->
<script type="text/javascript">

// Config
var host = "wss://streamssi.fxcorporate.com/streamssi/endpoint/EURUSD"; // No need to change this if using localhost


//Declare Variables
var socket;
//var explodedValues = [0,0,0,0]; //initial value for the plot = 0
var valueArr = [];
var timeArr = [];

function init() {
	try {
		socket = new WebSocket(host);
		console.log('WebSocket status '+socket.readyState);
		socket.onopen = function(msg) {
							   console.log("Welcome - status "+this.readyState);
						   };
		socket.onmessage = function(msg) {

							   //console.log("Message Received: "+msg.data);
                               var json = '' + msg.data;
                                //console.log(evt.data);
                                json = json.replace('ssi', '');
                                //console.log(json);
                                var objJSON = eval(json);

                    $.each(objJSON.SSI, function (index, event) {

                            var noSlashSymb = event.Symbol.replace('/', '').toUpperCase();
                            var pres = 10000;
                            var totalOrders = parseInt(event.LongAmountKOrders, 10) + parseInt(event.ShortAmountKOrders, 10);
                            var longPercent = parseInt(event.LongAmountKOrders) * 100 / totalOrders;
                            var longPercent = parseInt(longPercent.toFixed(0));

                            var longSSI = parseInt(event.LongAmountKOrders);
                            var shortSSI = parseInt(event.ShortAmountKOrders);
                            var timeUpdate = event.Time;
                            var timeUpdateHour = timeUpdate.slice(11, 19);


                            var shortPercent = 100.00 - longPercent;
                            var histOrders = Math.round(event.SSIHistOrders * pres) / pres;
                            var s = padZeroWS(histOrders);
                            $("#ssi-present-" + noSlashSymb).html(s);
                            $("#ssi-present-" + noSlashSymb + 0).html(s);
                            $("#ssi-present-" + noSlashSymb + 1).html(s);
                            $("#ssi-long-prc-" + noSlashSymb).html(longPercent + "%");
                            $("#ssi-long-prc-" + noSlashSymb + 0).html(longPercent + "%").css("width", longPercent + "%");
                            $("#ssi-long-prc-" + noSlashSymb + 1).html(longPercent + "%");
                            $("#ssi-short-prc-" + noSlashSymb).html(shortPercent + "%");
                            $("#ssi-short-prc-" + noSlashSymb + 0).html(shortPercent + "%").css("width", shortPercent + "%");
                            $("#ssi-short-prc-" + noSlashSymb + 1).html(shortPercent + "%");
                            $(".long-knob-" + noSlashSymb).val(longPercent).trigger('change');
                            $(".short-knob-" + noSlashSymb).val(shortPercent).trigger('change');
                            //console.log(noSlashSymb);

                            //explodedValues = s;  //can be access for outter function
                            //console.log(explodedValues);
                            var floatVal = parseFloat(s);

                            //var type = typeof(floatVal);

                            //console.log(type);


                            valueArr.push(floatVal);
                            timeArr.push(timeUpdateHour);

                            //console.log(timeArr);

                            /*var dataRow = ['SSI', floatVal];
                            var rowArr = [];
                            rowArr.push(dataRow);*/

   /*                         //console.log(valueArr);
                            var rand = parseInt(Math.random()*10);
                            //console.log(rowArr);
                            var testArr = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                            var num;

                            for(var i=0; i<valueArr.length; i++) {
                              //console.log(valueArr[i]);
                              //console.log(valueArr[0]);
                              //num = i;
                              //console.log(valueArr[i]);
                            }
                            //console.log(floatVal);*/

                              function drawVisualization() {
                              // Create and populate the data table from the values received via websocket
                              var data = new google.visualization.DataTable();
                              data.addColumn('string', 'Historical SSI');
                              data.addColumn('number', 'SSI');

                              for(var i=0; i<valueArr.length; i++) {
                                //console.log(valueArr[i]);
                                //console.log(valueArr[0]);
                                //num = i;
                                //console.log(valueArr[i]);
                                data.addRow([timeArr[i], valueArr[i]]);
                                //console.log(timeArr[0]);

                                if(i>60) {
                                  data.removeRow(0);
                                  //console.log('max out!!!');
                                }


                              }

                              //setTimeout(data.removeRow(0), 100);
                              //TODO remove the previous added rows
                              //look for the firstly added 5/10 rows
                              //removeRow of index
                              for(var i=0; i<valueArr.length; i++) {
                                //console.log(valueArr[i]);
                                //console.log(valueArr[0]);
                                //num = i;
                                //console.log(valueArr[i]);
                                //setTimeout(data.removeRow(0), 1000);
                                //data.removeRow(i-1);
                                //TODO remove the previous added rows
                                //data.removeRow([timeArr[0], valueArr[0]])
                              }


                              //console.log(valueArr[1]);
                              //setInterval(data.addRow(['SSI', 1.25]), 1000);
                              //setInterval(data.addRow(['SSI', 0.9]), 1000);
                              //setInterval(data.addRow(['SSI', 1.33]), 10);

                             //var x = 69;


                              // use a DataView to 0-out all the values in the data set for the initial draw
                              var view = new google.visualization.DataView(data);
                              view.setColumns([0, {
                                  type: 'number',
                                  label: data.getColumnLabel(1),
                                  calc: function () {return 0;}
                              }]);

                              // Create and draw the plot
                              var chart = new google.visualization.LineChart(document.getElementById('visualization'));

                              var options = {
                                  title:" ",
                                  width: 1440,
                                  height: 700,
                                  bar: { groupWidth: "40%" },
                                  legend: { position: "bottom" },
                                  animation: {"startup": true},
                                  curveType: 'function',
                                  lineWidth: 3
                                  /*vAxis: {
                                      // set these values to make the initial animation smoother
                                      minValue: 1.3,
                                      maxValue: 1.4
                                  }*/
                              };




    var runOnce = google.visualization.events.addListener(chart, 'ready', function () {
        google.visualization.events.removeListener(runOnce);
        chart.draw(data, options);
    });

    setInterval(chart.draw(view, options), 1000);
    clearInterval();

    // you can handle the resizing here - no need to recreate your data and charts from scratch
    $(window).resize(function() {
        chart.draw(data, options);
    });

}



google.load('visualization', '1', {packages: ['corechart'], callback: drawVisualization});
google.setOnLoadCallback(drawVisualization);
                            //console.log(valueArr)

                            //drawVisualization();
                            //console.log(explodedValues);

                    });


							//console.log("Separate Values: "+explodedValues);

							//convert strings to numbers
                      //console.log(valueArr[0]);
                      //console.log(typeof(valueArr[0]));



                                    function padZeroWS(histOrders) {
            var s = Math.abs(histOrders) + "0000";
            var i = s.indexOf('.');
            var m = histOrders < 0 ? '-' : '';
            return m + s.substr(0, i) + s.substr(i, i + 4);
        }

						   };
		socket.onclose   = function(msg) {
							   console.log("Disconnected - status "+this.readyState);
						   };
	}
	catch(ex){
		console.log(ex);
	}

}

function quit() {
	if (socket != null) {
		console.log("Close Socket");
		socket.close();
		socket=null;
	}
}

function reconnect() {
	quit();
	init();
}
</script>




<script type="text/javascript">

</script>

</head>
<body onload="init()">

<div id="visualization"></div>

<!--<button onclick="reconnect()">Reconnect</button>    -->

</body>
</html>